Test Exercise 1: Answers to the Questions
========================================================

This exercise considers an example of data that *do not satisfy* all the standard assumptions of simple regression.
In the considered case, one particular observation lies far off from the others, that is, it is an outlier. This violates
assumptions **A3** and **A4**, which state that all error terms **"\( \varepsilon_i \) are drawn from one and the same distribution with
mean zero and fixed variance \( \sigma^2 \)**. The dataset contains twenty weekly observations on **sales** and **advertising** of a
department store. The question of interest lies in estimating the effect of advertising on sales. One of the weeks
was *special*, as the store was also open in the *evenings* during this week, but this aspect will first be ignored in the
analysis.

* (a) Make the scatter diagram with sales on the vertical axis and advertising on the horizontal axis. What do you expect to find if you would fit a regression line to these data?
  
  ```{r echo=FALSE, warning=FALSE}
  library(ggplot2)
  df <- read.csv('TestExer1-sales-round1.csv')
  ggplot(df, aes(x=Advertising, y=Sales)) + geom_point(size=4, color='red')+ggtitle("Scatter Plot")
  ```
  + It seems that the regression line will be affected heavily by the extreme outlier point and the slope will change lot. Although there seems to be a postive corrleation in between the Advertising and the Sales (increasing Advertising increases Sales), the regression line will fail to capture the functional relationship  in general, as shown below.
  
  ```{r echo=FALSE, warning=FALSE}
  ggplot(df, aes(x=Advertising, y=Sales)) + geom_point(size=4, color='red') + stat_smooth(method="lm", se=TRUE, color='blue')+ggtitle("Regression line with standard error (95% confidence interval)")
  ```

* (b) Estimate the coefficients a and b in the simple regression model with sales as dependent variable and advertising as explanatory factor. Also compute the standard error and t-value of b. Is b significantly different from 0?

  + The equation of the regression line to fit is \(S_i=a+bA_i+\epsilon_i\). The coefficients \(a\) and \(b\) are computed as below, along with the standard error \(s_b\) and t-value \(t_b\) of (\b\). As we can see, with the t-test on \(H_0: \beta = 0 \) based on \(t_b = \frac{b}{s_b}\), we **can't reject the Null Hypothesis \(H_0\)** since \(|t_b| < 2\). Hence, \(b\) is **not significantly different** from \(0\).  
  
  \(\begin{align} 
  b = \frac{\sum\limits_{i}{(S_i-\bar{S})(A_i-\bar{A})}}{\sum\limits_{i}{(A_i-\bar{A})^2}}=r\frac{\sigma_S}{\sigma_A}=-0.324575.\\
  a = \bar{S} - b\bar{A} = 29.62689.\\
  \epsilon_i = S_i - a - bA_i.\\
  s = \sqrt\frac{1}{20-2}\sum\limits_{i=1}^{20}{\epsilon_i^2}=5.836474.\\
  s_b = \frac{s}{\sqrt{\sum\limits_{i=1}^{20}{(A_i-\bar{A})^2}}}=0.458911.\\
  t_b=\frac{b}{s_b}=-0.7072722.
  \end{align}\).
  
  

  ```{r echo=FALSE, warning=FALSE}
  b = cor(df$Sales, df$Advertising) * sd(df$Sales) / sd(df$Advertising)
  a = mean(df$Sales)-b*mean(df$Advertising)
  s = sqrt(sum((df$Sales-a-b*df$Advertising)^2)/18)
  s_b = s / sqrt(sum((df$Advertising - mean(df$Advertising))^2))
  t_b = b / s_b
  model <- lm(Sales~Advertising, df)
  summary(model)
  ```

* (c) Compute the residuals and draw a histogram of these residuals. What conclusion do you draw from this histogram?
  
  + As can be seen from the residual values \( \epsilon_i \) and also from the histogram, the residual corresponding to the outlier has an extreme value \(22\) where all the other residuals have values less than \(3\). This outlier point alone makes the distribution *right skewed*.
  
  
  ```{r echo=FALSE, warning=FALSE}
  e_i = df$Sales-a-b*df$Advertising
  print(sort(e_i))
  ggplot(model, aes(.resid))+geom_histogram(binwidth=0.5)+scale_x_continuous(breaks=seq(-5, 25, 5))+xlab("Residuals")+ggtitle("Histogram of Residuals")
  ggplot(model, aes(.fitted, .resid))+geom_point()+stat_smooth(method="loess")+geom_hline(yintercept=0, col="red", linetype="dashed")+xlab("Fitted values")+ylab("Residuals")+ggtitle("Residual vs Fitted Plot")+theme_bw()
  ggplot(model, aes(qqnorm(.stdresid)[[1]], .stdresid))+geom_point(na.rm = TRUE)+
      geom_abline(aes(qqline(.stdresid)))+xlab("Theoretical Quantiles")+ylab("Standardized Residuals")+
      ggtitle("Normal Q-Q")+theme_bw()
  ```

* (d) Apparently, the regression result of part (b) is not satisfactory. Once you realize that the large residual corresponds to the week with opening hours during the evening, how would you proceed to get a more satisfactory regression model?

  + Since the outlier point skewes the residual hitogram heavily on the right and has a huge impact on the slope of the regression line, it makes sense to delete this outlier point and continue our analysis. Alternatively we can replace Sales corresponding to the outlier point by the median Sales value.


* (e) Delete this special week from the sample and use the remaining 19 weeks to estimate the coefficients a and b in the simple regression model with sales as dependent variable and advertising as explanatory factor. Also compute the standard error and t-value of b. Is b significantly different from 0?

  + As we can see, with the t-test on \(H_0: \beta = 0 \) based on \(t_b = \frac{b}{s_b}\), we can reject the Null Hypothesis \(H_0\) (with \(95%\) confidence) since \(|t_b| > 2\). Hence, \(b\) is **significantly different** from \(0\).  

  \(\begin{align} 
  b = \frac{\sum\limits_{i}{(S_i-\bar{S})(A_i-\bar{A})}}{\sum\limits_{i=1}^{19}{(A_i-\bar{A})^2}}=r\frac{\sigma_S}{\sigma_A}=0.375.\\
  a = \bar{S} - b\bar{A} = 21.125.\\
  \epsilon_i = S_i - a - bA_i.\\
  s = \sqrt\frac{1}{19-2}\sum\limits_{i=1}^{19}{\epsilon_i^2}=1.053705.\\
  s_b = \frac{s}{\sqrt{\sum\limits_{i=1}^{17}{(A_i-\bar{A})^2}}}=0.08819642.\\
  t_b=\frac{b}{s_b}=4.251873.
  \end{align}\).
  
  

  ```{r echo=FALSE, warning=FALSE}
  #library(dplyr)
  #df <- df %>% filter(Advertising != 6 || Sales != 50)
  df <- df[!(df$Advertising == 6 & df$Sales == 50),]
  b = cor(df$Sales, df$Advertising) * sd(df$Sales) / sd(df$Advertising)
  a = mean(df$Sales)-b*mean(df$Advertising)
  s = sqrt(sum((df$Sales-a-b*df$Advertising)^2)/17)
  s_b = s / sqrt(sum((df$Advertising - mean(df$Advertising))^2))
  t_b = b / s_b
  model <- lm(Sales~Advertising, df)
  summary(model)
  
  ```{r echo=FALSE, warning=FALSE, message=FALSE}
  ggplot(df, aes(x=Advertising, y=Sales)) + geom_point(size=4, color='red') + stat_smooth(method="lm", se=TRUE, color='blue')+ggtitle("Regression line with standard error (95% confidence interval)")
  ggplot(model, aes(.resid))+geom_histogram(binwidth=0.1)+scale_x_continuous(breaks=seq(-3, 3, 0.5))+xlab("Residuals")+ggtitle("Histogram of Residuals")
  ggplot(model, aes(.fitted, .resid))+geom_point()+stat_smooth(method="loess")+geom_hline(yintercept=0, col="red", linetype="dashed")+xlab("Fitted values")+ylab("Residuals")+ggtitle("Residual vs Fitted Plot")+theme_bw()
  ggplot(model, aes(qqnorm(.stdresid)[[1]], .stdresid))+geom_point(na.rm = TRUE)+
      geom_abline(aes(qqline(.stdresid)))+xlab("Theoretical Quantiles")+ylab("Standardized Residuals")+
      ggtitle("Normal Q-Q")+theme_bw()
  ```

* (f) Discuss the differences between your findings in parts (b) and (e). Describe in words what you have learned from these results.

  + The presence of *outliers* (extreme points) in the data can change the linear regression results, it can even change a **statistically significant** independent variable (as found in part (e) with the **outlier point excluded** before the analysis) to a **non-significant** variable (as found in part (b) with the **outlier point included**). Since the outliers can have impact on the coefficients, hence they should be *removed* / replaced (e.g., with with median) first as pre-processing step before analysis. 
```
